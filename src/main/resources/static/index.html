<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="icon" href="images/favicon.png" type="image/png">
    <title>文件盒子</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #6c757d;
            --light-bg: #f8f9fa;
            --dark-text: #343a40;
            --light-text: #6c757d;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            /*background-color: var(--light-bg);*/
            background: linear-gradient(180deg, #f8f9fa 0%, #d9dde3 100%);
            color: var(--dark-text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        h1,
        h2 {
            text-align: center;
            margin-bottom: 15px;
        }

        button {
            display: block;
            width: fit-content;
        }

        textarea {
            width: 100%;
            height: 180px;
            /* bigger by default */
            box-sizing: border-box;
            resize: vertical;
            padding: 4px 5px;
        }

        select {
            padding: 5px;
            border-radius: 5px;
        }

        a {
            text-align: center;
            color: #0077cc;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .container {
            width: 100%;
            max-width: 1690px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .header-title {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            gap: 18px;
        }

        .header-title h1 {
            text-align: center;
            margin: 0;
        }

        .logo-wrapper {
            width: 60px;
            height: 60px;
        }

        .header-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 8px;
            /*box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);*/
        }

        #dropzone {
            border: 3px dashed #aaa;
            padding: 20px;
            text-align: center;
            color: #555;
            margin-bottom: 15px;
            border-radius: 10px;
            transition: background-color 0.3s ease;
            width: 100%;
            box-sizing: border-box;
            cursor: pointer;
        }

        #dropzone.dragover {
            background-color: #eef8ff;
            border-color: #33aaff;
            color: #0077cc;
        }

        #recent {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            margin: 0 auto;
            max-width: 100%;
        }

        #recent a {
            display: block;
            margin-bottom: 15px;
        }

        #recent a:hover {
            text-decoration: none;
        }

        .preview {
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 6px;
            width: 180px;
            height: 160px;
            overflow: hidden;
            word-break: break-word;
            box-sizing: border-box;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            transition: all 0.3s ease;
        }
        .preview pre {
            white-space: pre-wrap;
            max-height: 108px;
            overflow: auto;
            font-size: 12px;
        }
        .preview img,
        .preview video {
            max-width: 100%;
            max-height: 108px;
            border-radius: 4px;
            object-fit: contain;
        }
        .preview .full-filename {
            margin-top: auto;
            max-height: 108px;
            font-size: 14px;
            font-weight: bold;
            word-break: break-word;
            text-overflow: clip;
        }
        .preview .file-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: auto;
            gap: 1px;
            width: 100%;
        }
        .preview .filename {
            font-size: 11px;
            color: var(--dark-text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
            width: 100%;
        }

        /* 文件扩展名样式 */
        .preview .file-ext {
            font-size: 24px;
            font-weight: bold;
            color: rgba(67, 73, 78, 0.3);
            line-height: 1;
        }
        .preview small {
            font-size: 11px;
            color: var(--light-text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
            line-height: 1;
            transition: all 0.2s ease;
        }

        .preview:hover .delete-btn {
            display: block;
        }

        .delete-btn:hover {
            background-color: #cc0000;
            /*transform: scale(1.1);*/
        }

        .header-controls {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-group {
            font-size: 14px;
            color: var(--secondary-color);
            border: 1px solid var(--secondary-color);
            border-radius: 10px;
            padding-inline: 10px;
        }

        .user-info {
            font-size: 14px;
            color: var(--dark-text);
        }

        .user-info.admin {
            /*color: #ff4444;*/
            font-weight: bold;
        }
        .user-info.admin::before {
            content: "★";
            color: #ffcc00;
            margin-right: 3px;
            font-size: 16px;
        }

        .logout-link-container a {
            display: inline;
            margin: 0;
            color: #0077cc;
            text-decoration: none;
            font-size: 14px;
        }

        .logout-link-container a:hover {
            text-decoration: underline;
        }

        .btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow);
        }

        .btn:hover {
            background-color: #3a7bc8;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        /* 添加分割线样式 */
        .divider {
            height: 2px;
            background: linear-gradient(to right, #f0f0f0, #888, #f0f0f0);
            margin: 20px 0;
            border-radius: 1px;
        }

        .file-input-wrapper {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        #fileInput {
            display: none;
        }

        #periodSelector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        #periodSelector .date-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        #periodSelector #yearSelect {
            width: 100px;
        }

        #periodSelector #monthSelect {
            width: 80px;
        }

        /* 模态框样式 */
        #upload-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #upload-progress-container {
            width: 90%;
            max-width: 500px;
            padding: 20px;
            border-radius: 10px;
            background-color: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #upload-progress {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }

        #upload-progress-bar {
            height: 100%;
            width: 0%;
            background-color: #4a90e2;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        #upload-progress-percentage {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            pointer-events: none;
        }

        #upload-status {
            font-size: 16px;
            color: #333;
            text-align: center;
            margin-bottom: 15px;
        }

        #upload-details {
            display: flex;
            justify-content: space-between;
            margin: 10px 0 15px 0;
            font-size: 14px;
            color: #666;
            gap: 30px;
        }

        #upload-size-info {
            text-align: left;
        }

        #upload-speed {
            text-align: right;
        }

        #upload-cancel-btn {
            padding: 8px 20px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        #upload-cancel-btn:hover {
            background-color: #d32f2f;
        }

        /* 移动端优化 */
        @media (max-width: 600px) {
            body {
                /*margin: 10px;*/
            }

            .container {
                padding: 0 10px;
            }

            .user-group {
                display: none;
            }

            .delete-btn {
                width: 28px;
                height: 28px;
                font-size: 16px;
                padding: 0px;
            }
            #recent {
                justify-content: space-around;
            }
            #recent a {
                width: calc(50% - 10px);
            }

            .preview {
                width: 100%;
                height: 160px;
            }

            .preview img,
            .preview video {
                max-height: 100px;
            }

            .preview pre {
                font-size: 11px;
            }

            textarea {
                height: 120px;
            }

            button {
                width: 100%;
                padding: 10px;
            }

            #periodSelector {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>

<body>
<div class="header-controls">
        <div class="user-group" id="user-group"></div>
        <div class="user-info" id="user-info"></div>
        <div class="logout-link-container" id="login-logout-container"><a href="/logout">退出</a></div>
    </div>
<div class="container">
    <div class="header-title">
        <div class="logo-wrapper">
            <img src="images/logo.png" alt="文件盒子Logo" class="header-logo">
        </div>
        <h1>文件盒子</h1>
        <div class="logo-wrapper"></div>
    </div>

    <div id="dropzone" tabindex="0">
        在当前页面粘贴文件 (Ctrl+V / ⌘+V)
        <br/>
        或拖放文件到此处
        <!-- 文件上传入口 -->
        <div class="file-input-wrapper">
                <button id="selectFileBtn" class="btn">选择文件</button>
                <input type="file" id="fileInput" />
            </div>
    </div>

    <!-- 上传进度模态框 -->
    <div id="upload-modal-overlay">
        <div id="upload-progress-container">
            <div id="upload-status">准备上传...</div>
            <div id="upload-progress">
                <div id="upload-progress-bar"></div>
                <div id="upload-progress-percentage">0%</div>
            </div>
            <div id="upload-details">
                <span id="upload-size-info">0 B / 0 B</span>
                <span id="upload-speed">0 B/s</span>
            </div>
            <button id="upload-cancel-btn">取消上传</button>
        </div>
    </div>

    <textarea id="textpaste" placeholder="或在此粘贴文本"></textarea>
    <button id="sendText" class="btn">上传文本</button>

    <div class="divider"></div>


    <div id="periodSelector">
        <div class="date-selector">
            <select id="yearSelect"></select>
            <select id="monthSelect"></select>
        </div>
        <button id="loadBtn" class="btn"> 加 载</button>
    </div>

    <h2 id="uploadsTitle">最近上传的50个文件</h2>
    <div id="recent"></div>
</div>

<script>
    // 获取并显示用户组信息
    fetch('/api/user')
        .then(response => {
            if (!response.ok) {
                window.location.href = '/login.html';
                return;
            }
            return response.json();
        })
        .then(data => {
            const userGroupElement = document.getElementById('user-group');
            userGroupElement.textContent = data.groupName;
            const userInfoElement = document.getElementById('user-info');
            userInfoElement.textContent = data.username;
            window.currentRole = data.role;
            window.isAnonymous = data.isAnonymous || false;

            // 为管理员用户添加特殊样式
            if (data.role === 'admin') {
                userInfoElement.classList.add('admin');
                userInfoElement.title = '管理员用户 拥有删除文件权限！';
            }

            // 根据是否为匿名用户调整登录/退出链接
            const loginLogoutContainer = document.getElementById('login-logout-container');
            const loginLogoutLink = loginLogoutContainer.querySelector('a');
            if (window.isAnonymous) {
                // 匿名用户显示登录链接
                loginLogoutLink.href = '/login.html';
                loginLogoutLink.textContent = '登录';
            } else {
                // 已登录用户显示退出链接
                loginLogoutLink.href = '/logout';
                loginLogoutLink.textContent = '退出';
            }
        })
        .catch(() => {
            window.location.href = '/login.html';
        });
</script>
<script>

    const dropzone = document.getElementById("dropzone");
    const textpaste = document.getElementById("textpaste");
    const sendTextBtn = document.getElementById("sendText");
    const recentDiv = document.getElementById("recent");
    const uploadsTitle = document.getElementById("uploadsTitle");
    const fileInput = document.getElementById("fileInput");
    const selectFileBtn = document.getElementById("selectFileBtn");

    // 添加按钮点击事件触发文件选择
    selectFileBtn.addEventListener("click", (e) => {
        e.stopPropagation(); // 阻止事件冒泡，避免触发dropzone的点击事件
        fileInput.click();
    });

    let currentYear = null;
    let currentMonth = null;
    let currentXhr = null; // 用于保存当前的XMLHttpRequest对象，以便取消上传

    // Show hover style
    dropzone.addEventListener("dragover", e => {
        e.preventDefault();
        dropzone.classList.add("dragover");
    });
    dropzone.addEventListener("dragleave", e => {
        dropzone.classList.remove("dragover");
    });
    dropzone.addEventListener("drop", e => {
        e.preventDefault();
        dropzone.classList.remove("dragover");
        handleFiles(e.dataTransfer.files);
    });
    dropzone.addEventListener("click", () => fileInput.click());

    // 粘贴处理
    document.addEventListener("paste", e => {
        const items = (e.clipboardData || e.originalEvent?.clipboardData || window.clipboardData)?.items || [];
        let hasFiles = false;

        // 检查是否有文件粘贴
        for (let item of items) {
            if (item.kind === "file") {
                const file = item.getAsFile();
                if (file) {
                    hasFiles = true;
                    handleFiles([file]);
                    break; // 只处理第一个文件
                }
            }
        }

        // 如果有文件粘贴，阻止默认行为以避免冲突
        if (hasFiles) {
            e.preventDefault();
        } else {
            // 没有文件粘贴的情况
            if (e.target !== textpaste) {
                // 如果不是在文本输入框中粘贴，阻止默认行为并将文本放入输入框
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData("text");
                if (text) {
                    // 检测base64图像数据URI (移动设备粘贴常见)
                    if (text.startsWith("data:image")) {
                        fetch(text)
                            .then(res => res.blob())
                            .then(blob => {
                                const filename = "pasted_" + new Date().toISOString().replace(/[:.]/g, "") + ".png";
                                const file = new File([blob], filename, {type: blob.type});
                                uploadFiles([file]);
                            })
                            .catch(() => {
                                // 回退到文本输入框
                                textpaste.value = text;
                            });
                    } else {
                        textpaste.value = text;
                    }
                }
            }
            // 如果是在文本输入框中粘贴文本，不阻止默认行为，让浏览器正常处理
        }
    });

    fileInput.addEventListener("change", e => {
        const files = e.target.files;
        if (files.length > 0) {
            handleFiles(files);
            fileInput.value = ""; // 清除输入以允许重新选择相同文件
        }
    });

    sendTextBtn.addEventListener("click", () => {
        const txt = textpaste.value.trim();
        if (!txt) return alert("请输入一些文本");
        uploadText(txt);
    });

    // 取消上传按钮点击事件
    document.getElementById('upload-cancel-btn').addEventListener('click', () => {
        if (currentXhr) {
            currentXhr.abort(); // 取消上传
            currentXhr = null;
        }
        // 隐藏模态框
        document.getElementById('upload-modal-overlay').style.display = 'none';
    });

    function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
    }

    function handleFiles(files) {
        // 只处理第一个文件
        if (files.length > 0) {
            uploadFiles([files[0]]);
        }
    }


    function uploadFiles(files) {
        const formData = new FormData();
        const timestamp = new Date().toISOString().replace(/[:.]/g, "");
        const file = files[0]; // 只处理第一个文件
        const filename = file.name || `pasted_${timestamp}.bin`;
        formData.append("file", file, filename);

        // 显示进度模态框
        const modalOverlay = document.getElementById('upload-modal-overlay');
        const progressContainer = document.getElementById('upload-progress-container');
        const progressBar = document.getElementById('upload-progress-bar');
        const statusText = document.getElementById('upload-status');
        const progressPercentage = document.getElementById('upload-progress-percentage');
        const sizeInfo = document.getElementById('upload-size-info');
        const speedInfo = document.getElementById('upload-speed');
        modalOverlay.style.display = 'flex';
        progressBar.style.width = '0%';
        progressPercentage.textContent = '0%';
        statusText.textContent = `正在上传文件【${filename}】...`;
        sizeInfo.textContent = '0 B / 0 B';
        speedInfo.textContent = '0 B/s';
        // 恢复按钮文本为"取消上传"
        document.getElementById('upload-cancel-btn').textContent = '取消上传';

        // 上传速度计算变量
        let startTime = Date.now();
        let lastLoaded = 0;
        let lastTime = startTime;

        // 格式化字节大小
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 使用 XMLHttpRequest 实现带进度监听的文件上传
        currentXhr = new XMLHttpRequest();

        // 监听上传进度
        currentXhr.upload.addEventListener('progress', (event) => {
            if (event.lengthComputable) {
                const percentComplete = Math.round((event.loaded / event.total) * 100);
                progressBar.style.width = percentComplete + '%';
                progressPercentage.textContent = percentComplete + '%';
                statusText.textContent = `正在上传文件【${filename}】...`;
                
                // 更新已上传大小和总大小
                sizeInfo.textContent = `${formatBytes(event.loaded)} / ${formatBytes(event.total)}`;
                
                // 计算上传速度
                const currentTime = Date.now();
                const timeDiff = currentTime - lastTime;
                const bytesDiff = event.loaded - lastLoaded;
                
                if (timeDiff > 0) {
                    const speed = (bytesDiff * 1000) / timeDiff;
                    speedInfo.textContent = `${formatBytes(speed)}/s`;
                }
                
                lastLoaded = event.loaded;
                lastTime = currentTime;
            }
        });

        // 监听上传完成
        currentXhr.addEventListener('load', () => {
            if (currentXhr.status >= 200 && currentXhr.status < 300) {
                progressBar.style.width = '100%';
                statusText.textContent = `上传成功！文件【${filename}】已上传`;
                fetchFiles();
                // 3秒后隐藏模态框
                setTimeout(() => {
                    modalOverlay.style.display = 'none';
                }, 3000);
                // 上传成功后，修改按钮文本为"关闭"
                const cancelBtn = document.getElementById('upload-cancel-btn');
                cancelBtn.textContent = '关闭';                
            } else {
                statusText.textContent = `上传失败: ${currentXhr.statusText}`;
                // 上传失败时，修改按钮文本为"关闭"
                const cancelBtn = document.getElementById('upload-cancel-btn');
                cancelBtn.textContent = '关闭';
            }
            currentXhr = null;
        });


        // 监听上传错误
        currentXhr.addEventListener('error', () => {
            statusText.textContent = '上传失败: 网络错误';
            // 网络错误时，修改按钮文本为"关闭"
            const cancelBtn = document.getElementById('upload-cancel-btn');
            cancelBtn.textContent = '关闭';
            currentXhr = null;
        });

        // 监听上传被取消
        currentXhr.addEventListener('abort', () => {
            statusText.textContent = '上传已取消';
            setTimeout(() => {
                modalOverlay.style.display = 'none';
            }, 3000);
            currentXhr = null;
        });

        // 发送请求
        currentXhr.open('POST', '/upload_file', true);
        currentXhr.send(formData);
    }

    // 统一处理fetch请求，检测登录过期并重定向
    function handleFetch(url, options = {}) {
        return fetch(url, options).then(resp => {
            // 检查是否为重定向到登录页面（通常是302状态码）
            if (resp.redirected && resp.url.includes('/login')) {
                // 执行页面跳转
                window.location.href = resp.url;
                return Promise.reject('已跳转到登录页面');
            }
            return resp;
        }).catch(error => {
            // 捕获可能的错误，但不阻止登录页面跳转
            if (error !== '已跳转到登录页面') {
                console.error('请求错误:', error);
            }
            throw error;
        });
    }

    function uploadText(text) {
        handleFetch("/upload_text", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({text}),
        }).then(resp => {
            if (!resp.ok) alert("上传失败");
            else {
                textpaste.value = "";
                fetchFiles();
            }
        });
    }

    function fetchPeriods() {
        handleFetch("/list_periods").then(r => r.json()).then(data => {
            const periods = data.periods;
            const yearSelect = document.getElementById("yearSelect");
            yearSelect.innerHTML = '<option value="">最近上传</option>';
            periods.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.year;
                opt.textContent = p.year + " 年";
                yearSelect.appendChild(opt);
            });
            yearSelect.addEventListener("change", updateMonths);
            updateMonths();
        });
    }

    function updateMonths() {
        const year = document.getElementById("yearSelect").value;
        const monthSelect = document.getElementById("monthSelect");
        if (!year) {
            monthSelect.innerHTML = '<option value="">--</option>';
            monthSelect.disabled = true;
            return;
        }
        monthSelect.disabled = false;
        handleFetch("/list_periods").then(r => r.json()).then(data => {
            const p = data.periods.find(pp => pp.year === year);
            monthSelect.innerHTML = "";
            p.months.forEach(m => {
                const opt = document.createElement("option");
                opt.value = m;
                opt.textContent = m + " 月";
                monthSelect.appendChild(opt);
            });
        });
    }

    document.getElementById("loadBtn").addEventListener("click", () => {
        currentYear = document.getElementById("yearSelect").value;
        currentMonth = document.getElementById("monthSelect").value;
        fetchFiles();
    });

    function fetchFiles() {
        let url = "/list_files";
        let title = "最近上传的50个文件";
        if (currentYear && currentMonth) {
            url += `?year=${currentYear}&month=${currentMonth}`;
            title = `${currentYear}年-${currentMonth}月 上传的文件`;
        }
        uploadsTitle.textContent = title;
        handleFetch(url).then(r => r.json()).then(data => {
            recentDiv.innerHTML = "";
            if (data.files.length === 0) {
                recentDiv.textContent = "暂无上传文件";
                return;
            }
            for (let file of data.files) {
                const a = document.createElement("a");
                a.href = file.url;
                a.target = "_blank";

                const previewDiv = document.createElement("div");
                previewDiv.className = "preview";

                // 检查是否为可预览类型
                const isPreviewable = file.type === "text" || file.type === "image" || file.type === "video";

                if (isPreviewable) {
                    // 可预览文件：先显示内容
                    if (file.type === "text") {
                        const pre = document.createElement("pre");
                        pre.textContent = file.content;
                        previewDiv.appendChild(pre);
                    } else if (file.type === "image") {
                        const img = document.createElement("img");
                        img.src = file.url;
                        previewDiv.appendChild(img);
                    } else if (file.type === "video") {
                        const vid = document.createElement("video");
                        vid.src = file.url;
                        vid.controls = true;
                        previewDiv.appendChild(vid);
                    }
                } else {
                    //不可预览文件：直接显示大字体文件名作为主要内容
                    const fileNameDiv = document.createElement("div");
                    fileNameDiv.textContent = file.filename;
                    fileNameDiv.title = file.filename;
                    fileNameDiv.className = "full-filename";
                    previewDiv.appendChild(fileNameDiv);
                }

                const fileInfoDiv = document.createElement("div");
                fileInfoDiv.className = "file-info";
                previewDiv.appendChild(fileInfoDiv);

                if(isPreviewable){
                    // 可预览文件：显示小字体文件名
                    const filenameSpan = document.createElement("span");
                    filenameSpan.textContent = file.filename;
                    filenameSpan.title = file.filename; // 悬停显示完整文件名
                    filenameSpan.className = "filename";
                    fileInfoDiv.appendChild(filenameSpan);
                }else{
                    //不可预览文件：展示文件类型名称
                    const hasExtension = file.filename.includes('.');
                    let fileExt;
                    if (hasExtension) {
                        fileExt = file.filename.split('.').pop().toUpperCase();
                        fileExt = fileExt.length <= 5 ? fileExt : fileExt.substring(0, 5);
                    } else {
                        fileExt = 'UNKNOWN';
                    }
                    const fileExtDiv = document.createElement("div");
                    fileExtDiv.textContent = fileExt;
                    fileExtDiv.className = "file-ext";
                    fileInfoDiv.appendChild(fileExtDiv);
                }

                // 时间
                const timeDiv = document.createElement("small");
                timeDiv.textContent = file.time;
                fileInfoDiv.appendChild(timeDiv);

                // 如果是管理员，添加删除按钮（作为绝对定位元素，不影响布局）
                if (window.currentRole === 'admin') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.textContent = '×'; // 使用 Unicode 字符 U+00D7
                    deleteBtn.title = '删除文件';

                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        if (confirm(`确定要删除文件？\n ${file.filename}`)) {
                            // 从URL中提取文件路径
                            const filePath = file.url.replace(/^\/uploads/, '');
                            deleteFile(filePath, a); // 直接传递a元素
                        }
                    };

                    previewDiv.appendChild(deleteBtn);
                }

                a.appendChild(previewDiv);
                recentDiv.appendChild(a);
            }
        });
    }

    function deleteFile(filePath, element) {
        fetch(`/delete_file?path=${filePath}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (response.ok) {
                    alert('删除成功！');
                    // 如果提供了元素，则直接删除它
                    if (element && element.parentNode) {
                        element.parentNode.removeChild(element);
                    } else {
                        // 如果没有元素，刷新页面
                        window.location.reload();
                    }
                } else {
                    response.text().then(text => {
                        if (text) {
                            alert('删除失败!\n' + text);
                        } else {
                            alert('删除失败!');
                        }
                    }).catch(() => alert('删除失败!'));
                }
            })
            .catch(err => console.error('删除错误:', err));
    }

    fetchPeriods();
    fetchFiles();

</script>
</body>

</html>